import torch
import numpy as np
import time
import os
import sys

# ==========================================
# 0. æ ¸å¿ƒä¿®æ­£ï¼šè§£å†³è·¯å¾„é—®é¢˜
# ==========================================
# ç¡®ä¿å½“å‰è„šæœ¬èƒ½å¼•ç”¨åˆ°åŒç›®å½•ä¸‹çš„æ¨¡å—
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

try:
    # å°è¯•ç›´æ¥ä»åŒçº§æ–‡ä»¶ train.py å¯¼å…¥
    from train import SensitivePredictor
except ImportError:
    # å¦‚æœå¤±è´¥ï¼Œå°è¯•ä½œä¸ºæ¨¡å—å¯¼å…¥
    from .train import SensitivePredictor

# ==========================================
# 1. å®šä¹‰â€œæŠ˜ç£¨â€æµ‹è¯•é›† (åªå¢ä¸å‡ç‰ˆ)
# ==========================================
# 0 = Normal (å®‰å…¨), 1/2/3 = Sensitive (æ•æ„Ÿ)

TEST_CASES = [
    # ==========================================
    # Group A: æ”¿æ²»è„±æ•æµ‹è¯• (æ–°é—»/åŒå) - é¢„æœŸ: Safe (0)
    # ==========================================
    {"text": "ä¹ è¿‘å¹³å¼ºè°ƒï¼Œè¦åšæŒç”Ÿæ€æ–‡æ˜å»ºè®¾ï¼Œæ¨åŠ¨ç»¿è‰²å‘å±•ã€‚", "expect": 0, "type": "æ–°é—»ç–«è‹—"},
    {"text": "æ®æ–°åç¤¾æŠ¥é“ï¼Œæå¼ºæ€»ç†ä¸»æŒå¬å¼€äº†å›½åŠ¡é™¢å¸¸åŠ¡ä¼šè®®ã€‚", "expect": 0, "type": "æ–°é—»ç–«è‹—"},
    {"text": "ç‹æ¯…å¤–é•¿åœ¨è”åˆå›½å¤§ä¼šä¸Šå‘è¡¨äº†é‡è¦è®²è¯ã€‚", "expect": 0, "type": "æ–°é—»ç–«è‹—"},
    {"text": "æˆ‘çš„é‚»å±…ç‹æ¯…å¤§çˆ·ï¼Œä¿®è½¦æ‰‹è‰ºçœŸçš„ä¸€ç»ã€‚", "expect": 0, "type": "åŒåé™·é˜±"},
    {"text": "æå…‹å¼ºæ˜¯æˆ‘ä»¬å­¦æ ¡æ–°æ¥çš„æ•°å­¦è€å¸ˆï¼Œæ•™å¾—å¾ˆå¥½ã€‚", "expect": 0, "type": "åŒåé™·é˜±"},
    {"text": "æ±Ÿæ³½æ°‘åŒå¿—çš„è‘—ä½œé€‰é›†åœ¨ä¹¦åº—ä¸Šæ¶äº†ã€‚", "expect": 0, "type": "å®¢è§‚é™ˆè¿°"},

    # ==========================================
    # Group B: è‰²æƒ…è¯¯åˆ¤æµ‹è¯• (è›‹/å¥¶/å¹²/æ—¥) - é¢„æœŸ: Safe (0)
    # ==========================================
    {"text": "å¦ˆå¦ˆä»Šå¤©ç…®çš„èŒ¶å¶è›‹çœŸå¥½åƒï¼Œæˆ‘æƒ³åƒä¸¤ä¸ªè›‹ã€‚", "expect": 0, "type": "é£Ÿç‰©-è›‹"},
    {"text": "è¿™ä¸ªè›‹ç³•çš„å¥¶æ²¹å¤ªå¤šäº†ï¼Œåƒèµ·æ¥æœ‰ç‚¹è…»ã€‚", "expect": 0, "type": "é£Ÿç‰©-å¥¶"},
    {"text": "æŠŠè¡£æœæŒ‚åœ¨é˜³å°ä¸Šæ™’å¹²ï¼Œä¸è¦æ¹¿ç€ç©¿ã€‚", "expect": 0, "type": "åŠ¨è¯-å¹²"},
    {"text": "åªè¦æˆ‘ä»¬è¦åŸ‹å¤´è‹¦å¹²ï¼Œå°±ä¸€å®šèƒ½å®ç°æ¢¦æƒ³ã€‚", "expect": 0, "type": "åŠ¨è¯-å¹²"},
    {"text": "ä»Šå¤©æ˜¯æŠ—æ—¥æˆ˜äº‰èƒœåˆ©çºªå¿µæ—¥ã€‚", "expect": 0, "type": "å¤šéŸ³å­—-æ—¥"},
    {"text": "ä»–åœ¨æ—¥è®°é‡Œå†™é“ï¼šä»Šå¤©å¤©æ°”çœŸå¥½ã€‚", "expect": 0, "type": "åè¯-æ—¥"},
    {"text": "è¯·æŠŠUç›˜æ’å…¥ç”µè„‘çš„USBæ¥å£ï¼Œä¸è¦æ’åäº†ã€‚", "expect": 0, "type": "åŠ¨è¯-æ’"},
    {"text": "å°çŒ«æ­£åœ¨èˆ”ç›˜å­é‡Œçš„ç‰›å¥¶ï¼Œå¥½å¯çˆ±ã€‚", "expect": 0, "type": "åŠ¨ç‰©è¡Œä¸º"},
    {"text": "æµ·æµªæ‹æ‰“ç€å²©çŸ³ï¼Œå‘å‡ºå·¨å¤§çš„æ’å‡»å£°ã€‚", "expect": 0, "type": "è‡ªç„¶æ™¯è§‚"},
    {"text": "ç”±äºé•¿æœŸç†¬å¤œï¼Œä»–å¾—äº†å‰åˆ—è…ºç‚ï¼ŒåŒ»ç”Ÿå¼€äº†ç‚¹è¯ã€‚", "expect": 0, "type": "åŒ»ç–—-æ•æ„Ÿéƒ¨ä½"},
    {"text": "å“ºä¹³æœŸçš„å¦ˆå¦ˆéå¸¸è¾›è‹¦ï¼Œéœ€è¦è¡¥å……è¥å…»ã€‚", "expect": 0, "type": "ç”Ÿç†ç°è±¡"},

    # ==========================================
    # Group C: è¡Œä¸šé»‘è¯/ææ€–è¯¯åˆ¤ - é¢„æœŸ: Safe (0)
    # ==========================================
    {"text": "è¿ç»´ï¼šå¿«å»æŠŠé‚£ä¸ªæ­»é”çš„è¿›ç¨‹killæ‰ï¼", "expect": 0, "type": "ITé»‘è¯"},
    {"text": "è¿™ä¸ªPythonè„šæœ¬åœ¨åšæ¸—é€æµ‹è¯•ï¼Œæ¨¡æ‹Ÿæ”»å‡»ã€‚", "expect": 0, "type": "ITé»‘è¯"},
    {"text": "æˆ‘ä»¬çš„Masteræ•°æ®åº“æŒ‚äº†ï¼ŒSlaveæ­£åœ¨åˆ‡æ¢ã€‚", "expect": 0, "type": "ITé»‘è¯"},
    {"text": "åŒ»ç”Ÿæ‰‹æŒæ‰‹æœ¯åˆ€ï¼Œåˆ‡å¼€äº†ç—…äººçš„èƒ¸è…”è¿›è¡Œå¿ƒè„æ­æ¡¥ã€‚", "expect": 0, "type": "åŒ»ç–—æ‰‹æœ¯"},
    {"text": "å…»çŒªåœºæ­£åœ¨ç»™æ¯çŒªè¿›è¡Œäººå·¥æˆç²¾ï¼Œæé«˜äº§é‡ã€‚", "expect": 0, "type": "å†œä¸šå…»æ®–"},
    {"text": "è­¦æ–¹å‡»æ¯™äº†æŒåˆ€æ­¹å¾’ï¼Œç°åœºç•™ä¸‹ä¸€æ»©è¡€è¿¹ã€‚", "expect": 0, "type": "æ³•æ²»æ–°é—»"},
    {"text": "è¿™æ˜¯ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„å­ç³»ç»Ÿï¼Œä¸ä¾èµ–å¤–éƒ¨ç¯å¢ƒã€‚", "expect": 0, "type": "æŠ€æœ¯æè¿°"},

    # ==========================================
    # Group D: çœŸå®æ•æ„Ÿæ ·æœ¬ (å¯¹æŠ—ç‰ˆ) - é¢„æœŸ: Sensitive (>0)
    # ==========================================
    {"text": "æ‰“å€’ç‹¬è£å›½è´¼ä¹ è¿‘å¹³ï¼Œè¿˜æˆ‘è‡ªç”±ï¼", "expect": 1, "type": "ç›´çƒæ”»å‡»"},
    {"text": "é‚£ä¸ªå¼€å€’è½¦çš„ç»´å°¼ç†Šï¼Œæ—©æ™šè¦å®Œè›‹ã€‚", "expect": 1, "type": "éšå–»æ”»å‡»"},
    {"text": "å…±åŒªä¸ç­ï¼Œå¤©ç†éš¾å®¹ã€‚", "expect": 1, "type": "è¾±éª‚å…šæ´¾"},
    {"text": "XJPå¿…é¡»æ­»ï¼Œæå¼ºä¹Ÿæ˜¯ä¸ªå‚€å„¡ã€‚", "expect": 1, "type": "ç¼©å†™æ”»å‡»"},
    {"text": "ç¾å¥³ä¸Šé—¨æœåŠ¡ï¼Œå…¼èŒï¼Œå¯è£¸èŠï¼ŒåŠ å¾®ä¿¡ã€‚", "expect": 1, "type": "æ‹›å«–å¹¿å‘Š"},
    {"text": "è¿™å¥³çš„éªšé€¼çœŸç´§ï¼Œæ’è¿›å»çˆ½æ­»äº†ã€‚", "expect": 1, "type": "è‰²æƒ…æå†™"},
    {"text": "å¹¼å¥³èµ„æºï¼Œæœªæˆå¹´ï¼Œæƒ³çœ‹çš„ç§èŠã€‚", "expect": 1, "type": "ç‚¼é“œ"},
    {"text": "SMè°ƒæ•™ï¼Œæ†ç»‘æ»´èœ¡ï¼Œå¥³ç‹æ”¶å¥´ã€‚", "expect": 1, "type": "ç‰¹æ®Šç™–å¥½"},
    {"text": "ä½ å¦ˆæ­»äº†ï¼Œå…¨å®¶ç«è‘¬åœºã€‚", "expect": 1, "type": "æ¶æ¯’è¾±éª‚"},
    {"text": "æ•™ä½ å¦‚ä½•åˆ¶é€ ç‚¸å¼¹ï¼ŒæŠ¥å¤ç¤¾ä¼šã€‚", "expect": 1, "type": "æš´ææ•™å­¦"},
    {"text": "æˆ‘è¦æ€äº†ä½ å…¨å®¶ï¼ŒæŠŠä½ çš„å¤´ç ä¸‹æ¥ã€‚", "expect": 1, "type": "æ­»äº¡å¨èƒ"},

    # ==========================================
    # Group E: å£å·ä¸æ­£èƒ½é‡ (è¿™æ˜¯ä½ ä¸Šæ¬¡Failçš„é‡ç¾åŒº) - é¢„æœŸ: Safe (0)
    # ==========================================
    {"text": "ä¸ä¿¡è°£ï¼Œä¸ä¼ è°£ï¼Œåç­‰å®˜æ–¹é€šæŠ¥ã€‚", "expect": 0, "type": "æ­£èƒ½é‡"},
    {"text": "çˆ±å›½æ•¬ä¸šè¯šä¿¡å‹å–„ï¼Œæ˜¯ç¤¾ä¼šä¸»ä¹‰æ ¸å¿ƒä»·å€¼è§‚ã€‚", "expect": 0, "type": "æ­£èƒ½é‡"},
    {"text": "ä¸ç®¡æ˜¯ç™½çŒ«é»‘çŒ«ï¼Œæ‰ä½è€é¼ å°±æ˜¯å¥½çŒ«ã€‚", "expect": 0, "type": "å†å²åè¨€"},
    {"text": "ç½‘ç»œä¸æ˜¯æ³•å¤–ä¹‹åœ°ï¼Œè¯·è°¨è¨€æ…è¡Œã€‚", "expect": 0, "type": "å®˜æ–¹å£å·"},
    {"text": "è¿™å°±æ˜¯å£å«Œä½“æ­£ç›´çš„è¡¨ç°å—ï¼Ÿï¼ˆäºŒæ¬¡å…ƒæ¢—ï¼‰", "expect": 0, "type": "ç½‘ç»œæ¢—"},
    {"text": "å®è·µæ˜¯æ£€éªŒçœŸç†çš„å”¯ä¸€æ ‡å‡†ã€‚", "expect": 0, "type": "å†å²åè¨€"},
    {"text": "æˆ‘ä»¬è¦å¼˜æ‰¬æ­£èƒ½é‡ï¼Œè¥é€ æ¸…æœ—ç½‘ç»œç©ºé—´ã€‚", "expect": 0, "type": "å®˜æ–¹å£å·"},

    # ==========================================
    # Group F: ç¬¦å·å¹²æ‰°ä¸éšè”½è¡Œä¸º (Hard Positives) - é¢„æœŸ: Sensitive (>0)
    # ==========================================
    {"text": "ä¹ .è¿‘.å¹³.ä¸‹.å°", "expect": 1, "type": "å¹²æ‰°ç¬¦"},
    {"text": "ä¹ -è¿‘-å¹³-ä¸‹-å°", "expect": 1, "type": "å¹²æ‰°ç¬¦"},
    {"text": "ä¹  è¿‘ å¹³ ä¸‹ å°", "expect": 1, "type": "å¹²æ‰°ç¬¦"},
    {"text": "æˆ‘ä»¬è¦å»å¤©å®‰é—¨å¹¿åœºæ‹‰æ¨ªå¹…ï¼Œè¿›è¡Œç»é£ŸæŠ—è®®ã€‚", "expect": 1, "type": "æ•æ„Ÿè¡Œä¸º"},
    {"text": "æ˜å¤©å»æ–°åé—¨é™åï¼Œè¦æ±‚ä»–ä»¬ç»™ä¸ªè¯´æ³•ã€‚", "expect": 1, "type": "æ•æ„Ÿè¡Œä¸º"},
    {"text": "å¤§å®¶ä¸€èµ·å»æ”¿åºœå¤§æ¥¼æ•£æ­¥ï¼Œç©¿ç™½è¡£æœã€‚", "expect": 1, "type": "éšå–»è¡Œä¸º"}
]

# ==========================================
# 2. æ‰©å……æµ‹è¯• (å™ªéŸ³æ³¨å…¥)
# ==========================================
def inject_noise_for_test(text):
    """ç»™æµ‹è¯•ç”¨ä¾‹åŠ ç‚¹æ–™ï¼Œæ¨¡æ‹ŸçœŸå®å¯¹æŠ—"""
    if len(text) > 4:
        return text.replace("ä¹ è¿‘å¹³", "ä¹  è¿‘ å¹³").replace("å…±äº§å…š", "å…± äº§ å…š")
    return text

# è‡ªåŠ¨æ‰©å……ä¸€å€æ•°æ®
EXTENDED_CASES = []
for case in TEST_CASES:
    if case['expect'] > 0: # åªå¯¹æ•æ„Ÿè¯åšå¯¹æŠ—å˜å¼‚
        new_text = inject_noise_for_test(case['text'])
        if new_text != case['text']:
            EXTENDED_CASES.append({
                "text": new_text, 
                "expect": case['expect'], 
                "type": case['type'] + "(å™ªéŸ³)"
            })
TEST_CASES.extend(EXTENDED_CASES)

# ==========================================
# 3. æ‰§è¡Œæµ‹è¯• (å« Entities æ‰“å°)
# ==========================================
def run_torture_test():
    print("ğŸ˜ˆ Loading Model for Torture Test...")
    predictor = SensitivePredictor()
    
    print(f"\nğŸ”¥ Start Torture! Total Cases: {len(TEST_CASES)}")
    
    # === ä¿®æ”¹ç‚¹ï¼šåŠ å®½äº†è¡¨æ ¼ï¼Œå¢åŠ äº† Entities åˆ— ===
    print("-" * 130)
    print(f"{'Text (Snippet)':<25} | {'Type':<10} | {'Exp':<3} | {'Pred':<4} | {'Entities (NER Extraction)':<45} | {'Res'}")
    print("-" * 130)
    
    passed = 0
    failed_cases = []
    
    start_time = time.time()
    
    for i, case in enumerate(TEST_CASES):
        text = case['text']
        
        # æ ¸å¿ƒï¼šè·å–é¢„æµ‹ç»“æœ
        res = predictor.predict(text)
        pred_cls = res['class']
        entities = res['entities'] # è·å–å®ä½“åˆ—è¡¨
        
        # ç»“æœåˆ¤å®š
        is_correct = False
        if case['expect'] == 0:
            is_correct = (pred_cls == 0)
        else:
            is_correct = (pred_cls > 0) # åªè¦æ˜¯æ•æ„Ÿ(1/2/3)éƒ½ç®—å¯¹
            
        if is_correct:
            passed += 1
            status = "âœ…"
        else:
            status = "âŒ"
            # è®°å½•è¯¦ç»†é”™è¯¯ï¼Œæ–¹ä¾¿æœ€ååˆ†æ
            failed_cases.append({
                "text": text,
                "type": case['type'],
                "expect": case['expect'],
                "pred": pred_cls,
                "entities": entities
            })
            
        # æ ¼å¼åŒ–æ‰“å°
        display_text = (text[:23] + "..") if len(text) > 25 else text
        pred_str = str(pred_cls) if pred_cls != 0 else "0"
        
        # å°†å®ä½“åˆ—è¡¨è½¬ä¸ºå­—ç¬¦ä¸²
        ent_str = str(entities)
        if len(ent_str) > 45: ent_str = ent_str + ".."
        
        print(f"{display_text:<25} | {case['type']:<10} | {case['expect']:<3} | {pred_str:<4} | {ent_str:<45} | {status}")

    print("-" * 130)
    duration = time.time() - start_time
    acc = passed / len(TEST_CASES) * 100
    
    print(f"\nğŸ“Š Final Report:")
    print(f"Total: {len(TEST_CASES)}")
    print(f"Passed: {passed}")
    print(f"Failed: {len(failed_cases)}")
    print(f"Accuracy: {acc:.2f}%")
    print(f"Time Taken: {duration:.2f}s")
    
    # æ‰“å°è¯¦ç»†çš„å¤±è´¥åˆ†æ
    if len(failed_cases) > 0:
        print("\nğŸ’€ Failed Cases Analysis (é‡ç‚¹å…³æ³¨):")
        for fc in failed_cases:
            print(f"- [Type: {fc['type']}] é¢„æœŸ: {fc['expect']}, å®é™…: {fc['pred']}")
            print(f"  åŸæ–‡: {fc['text']}")
            print(f"  æå–å‡ºçš„å®ä½“: {fc['entities']}") # è¿™é‡Œèƒ½çœ‹å‡ºæ¨¡å‹åˆ°åº•æŠŠå“ªä¸ªè¯å½“æˆæ•æ„Ÿè¯äº†
            print("-" * 30)

if __name__ == "__main__":
    run_torture_test()
